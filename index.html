<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <style>
      * {
        box-sizing: border-box;
      }
      html, body {
        height: 100%;
        margin: 0;
      }
      body {
        padding: 1em;
        display: flex;
        flex-direction: column;
        align-items: stretch;
      }
      pre {
        flex: 1;
      }
    </style>
  </head>
  <body>
    <pre>talky thing</pre>
    <input placeholder='message'>
    <script src="socketpeer.js"></script>
    <script>

      var code = location.search.substr(1);
      var big = Math.pow(16,10);
      var connect = false;

      if (!code) {
        code = ((Math.random() * big |0)+ big).toString(16);
        history.replaceState(null, null, "?" + code);
      }

      var peer = new SocketPeer({
        pairCode: code,
        url: location.origin
      });

      var out = document.querySelector('pre');
      function write(msg) {
        var d = new Date();
        var stamp = [d.getHours(), d.getMinutes(), d.getSeconds()].join(':');
        out.innerHTML += '<div>[' + stamp + ']  ' + msg + '</div>';
        out.scrollTop = out.scrollHeight;
      }

      var input = document.querySelector('input');
      input.addEventListener('keypress', function (e) {
        if (e.keyCode === 13 && connected) {
          e.preventDefault();
          write('<b>you:</b> ' + input.value);
          peer.send(input.value);
          input.value = '';
          input.focus();
        }
      });

      peer.on('data', function (data) {
        write('<b>them:</b> ' + data);
      });

      peer.on('upgrade', function() {
        write('upgraded to p2p');
        connected = true;
      });

      peer.on('connect', function() {
        write('negotiating with peer');
      });

      peer.on('busy', function () {
        write('peer connected to someone else')
      });

      peer.on('error', function (err) {
        write('connection error: ' + err);
      });

      peer.on('downgrade', function () {
        write('p2p connection broken');
        connected = false;
      });

      write('waiting for peer at ' + location.href);
      </script>
  </body>
</html>
